; ============================================
; Supervisor 配置文件
; 安装: sudo apt install supervisor
; 部署: sudo cp celery_service.conf /etc/supervisor/conf.d/kolors.conf
; 启动: sudo supervisorctl reread && sudo supervisorctl update
; ============================================

[program:kolors_api]
command=/opt/kolors/venv/bin/python /opt/kolors/api.py
directory=/opt/kolors
user=kolors
environment=HOME="/home/kolors",PATH="/opt/kolors/venv/bin:%(ENV_PATH)s"
autostart=true
autorestart=true
startsecs=5
startretries=3
stderr_logfile=/var/log/kolors/api.err.log
stdout_logfile=/var/log/kolors/api.out.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10

[program:kolors_worker]
; 关键参数: --concurrency=1 确保单 GPU 单任务
command=/opt/kolors/venv/bin/celery -A local_worker worker --loglevel=info --concurrency=1 --prefetch-multiplier=1
directory=/opt/kolors
user=kolors
environment=HOME="/home/kolors",PATH="/opt/kolors/venv/bin:%(ENV_PATH)s"
autostart=true
autorestart=true
startsecs=10
startretries=3
stderr_logfile=/var/log/kolors/worker.err.log
stdout_logfile=/var/log/kolors/worker.out.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
; 优雅关闭: 等待当前任务完成
stopwaitsecs=330
stopsignal=TERM
stopasgroup=true
killasgroup=true

[group:kolors]
programs=kolors_api,kolors_worker
priority=999
